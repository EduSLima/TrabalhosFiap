---
title: "ANALISE DO DATASET WINE QUALITY"
output:
  word_document: default
  pdf_document: default
---

###  **"Conceitos Estatísticos para IA"**  
####  *Prof. Adelaide Alves de Oliveira*

<br/>

* TURMA: FIAP-06IA
  + EDUARDO MORARES
  + EDUARDO SIQUEIRA DE LIMA
  + GABRIEL SHIKAMA
  + RICARDO KALIMANIS

<br/><br/>
Inicicalmente vamos instalar os pacotes, caso seja necessário, que serão usados no decorrer da análise
```{r}

#ignorando alertas para não poluir a exibição do markdwon
options(warn =-1)

#lista de pacotes que iremos utilizar no projeto
Pacotes_Necessarios <- c("ggplot2","readr","dplyr", "corrgram","corrplot", "plotly","skimr","gridExtra","GGally","gmodels")

#com base nos pacotes instalados crio uma variavel somente com os pacotes que não temos ainda para realizar a instalação 
#dos pacotes que de fato não possuimos
PacotesNovos <- Pacotes_Necessarios[!(Pacotes_Necessarios %in% installed.packages()[,"Package"])]
if(length(PacotesNovos)){ install.packages(PacotesNovos)} else {print("Todos os Pacotes Estão Instalados")}

```



Carregando todas as as Bibliotecas mencionadas no passo anterior
```{r, results="hide"}
lapply(Pacotes_Necessarios, require, character.only = TRUE)
```



Importando os Datasets de Wines Quality.


#### Lista DE - PARA das colunas



Nome no Arquivo     |  Nome Traduzido
----------------    |-----------------
ID                  |ID (que não sera utilizado)
fixed acidity       |acidez_fixa
volatile acidity    |acidez_volatil
citric acid         |acido_citrico	
residual sugar      |acucar_residual
chlorides           |cloretos
free sulfur dioxide |fsd
total sulfur dioxide|tsd
density             |densidade
pH                  |PH
sulphates           |sulfatos
alcohol             |grau_alcolico
quality             |qualidade
Vinho               |Tipo


```{r, results="hide"}

#Criando uma variável nome_colunas que receberá os nomes das colunas que normalizaremos a fim de facilitar o resto da análise
nome_colunas <- c("id","acidez_fixa","acidez_volatil","acido_citrico","acucar_residual","cloretos", "fsd", "tsd","densidade","PH", "sulfatos","grau_alcolico","qualidade","tipo")

#uso da biblioteca readr é para obter uma performance de carga melhor que a lib padrão do R
#e escolhemos o read_csv2 justamente pelo fato do arquivo estar separado por ; ao invés de ,
#o separador decimal também não é o . que é convencional e este comando ja os converte facilmente
#skip = 1 para ignorar o cabecalho que mudamos para melhor entendimento
vinhos <- read_csv2("./DataSets/BaseWine_Red_e_White.csv" ,col_names = nome_colunas, skip = 1)


```


Adicionando uma classificação de bom ou ruim de acordo com sua nota, onde menor que 5 é ruim até 7 bom e acima disso excelente

```{r}

#converte tipo paara fator
vinhos$tipo <- factor(vinhos$tipo, ordered = T)

#Criando uma coluna de Ranking para dizer o quão bom é o vinho
vinhos$rating <- factor(ifelse(vinhos$qualidade <= 5, 'Ruim', ifelse(vinhos$qualidade <= 7, 'Bom', 'Excelente')))

```



Exibindo os dados das dimensões, sumário, estrutura e as primeiras linhas do DataFrame Vinhos

```{r ,results="hide"}

attach(vinhos)

```

```{r}
#demonstrando as quantidades de dimensoes de ambos datasets

dim(vinhos)
skim(vinhos[, names(vinhos) != "id"] ) #retirando a coluna ID da análise
str(vinhos)
head (vinhos,3)

```

Observa-se que:

* O campo `acucar_residual` e `fsd` possuem um desvio padrão acima das demais variaveis
* A maioria dos histogramas apresenta uma distribuição normal entretanto não centralizado o que pode indicar a presença de outliers



### Verificando valores nulos

```{r}

sapply(vinhos, function(x)all(is.na(x)))

```


O resultado acima nos descreve que não há presença de nulos na base, isto é indicado pelo retorno `FALSE` em cada variável


```{r}

Rotulos_Colunas <-c("id","acidez_fixa","acidez volatil"	,"acido citrico","acucar residual","cloretos","fsd","tsd","densidade",			
                    "PH","sulfatos","grau alcolico","qualidade","tipo")

grafico_lista <- vector("list", length = length(Rotulos_Colunas)-2)

for(i in 2:13){
  grafico_lista[[i-1]] <- plot_ly(x = as.formula(vinhos[i]),   type = 'histogram', name = Rotulos_Colunas[i])
}  
subplot(grafico_lista,  nrows = 4)

```



Podemos observar que apesar do desenho ser similar à uma distribuição normal, isso se deu pois mais à esquerda exceto grau alcoolico, que se sabe
que não há vinhos com teor alcoolico abaixo de 6.5% (levendo em consideração um vinho de sobremesa mais licoroso). portanto nosso proximo objeto de
estudo será o grau alcoolico a procura de outliers e a remoção dos mesmos.


```{r }
p <- function(..., sep = ''){
  paste(..., collapse = sep)
}

fn_Exibir_Dispersao <- function (col, columnName){
  print(p('O menor elemento de', columnName, ' é', min(col)))
  print(p('O maior elemento de', columnName, ' é', max(col)))
  print(p('Variação Populacional de', columnName, 'é', var(col), sep = ' '))
  print(p('Desvio padrão de', columnName, 'é', sd(col), sep = ' '))
  print(p('A média dos valores de ', columnName, 'é', mean(col), sep = ' '))
  print(p('A diferença entre a média e a mediana é de', columnName, 'é', abs(mean(col) - sd(col)), sep = ' '))
}
```


```{r}

fn_Exibir_Dispersao(vinhos$grau_alcolico, 'Teor Alcoolico')

plot_ly(y = grau_alcolico, type = "box", name = 'Teor Alcoolico') 


```


Parece que existem elementos que nos levam a crer que de fato não são condizentes com o minimo de teor alcoolico existente para vinhos
iremos analisar melhor as observações onde o teor alcoolico é menor que 6º
``` {r}

subset(vinhos, grau_alcolico <6)

````


Olhando a tabela percebmos que existem 4 observações para vinho tinto que nos parecem ser erros de digitação iremos criar a partir deste momento um novo
data frame para trabalhar a limpeza dos dados preservando o original por questões de segurança e em seguida imprimiremos os graficos novamente para a variavel grau alcoolico


``` {r}

vinhos_ajustado <- subset(vinhos, grau_alcolico > 6)

grafico_lista <- vector("list", length = 2)

grafico_lista[[1]] <-  plot_ly(x = vinhos_ajustado$grau_alcolico, type = 'histogram', name = 'Histograma')
grafico_lista[[2]] <-  plot_ly(y = vinhos_ajustado$grau_alcolico, type = "box", name = 'Teor Alcoolico')

subplot(grafico_lista,  nrows = 1)

````

Após a remoção do erro na coluna `grau_alcoolico` os dados se demosntraram melhores dispostos no entanto ainda há indicios que existam outliers que devem 
ser melhor analisados


Antes de aprofundar a análise, achamos interessante avaliar o comportamento de cada variável agrupada por Tipo de Vinho. 
abaixo teremos um agrupamento por tipo de vinho mostrando a media, mediana e o desvio padrão

``` {r}

aggregate(vinhos_ajustado[,-13],  by = list(vinhos_ajustado$tipo),  FUN = mean)
aggregate(vinhos_ajustado[,-13],  by = list(vinhos_ajustado$tipo),  FUN = median)
aggregate(vinhos_ajustado[,-13],  by = list(vinhos_ajustado$tipo),  FUN = sd)

```

Notamos que há bastante diferença entre algumas variaveis como :
  * acidez fixa, volatil, cloretos e sultatos é maior em vinhos tintos,  <----- montar uma matriz
  * acido citrico, acucar residual, fsd e tsd é muito maior em vinhos brancos

devido ao comportamento particular de cada tipo de vinho pensamos que é interessante efetuar a análise dos dados de maneira independente


### **Outliers**

Nota se que quase  todas as variáveis possuem outliers e para uma melhor acurácia no modelo iremos removê-las da análise.
O Metodo mais indicado para remoção dos outliers é amplitude interquartil (IQR - InterQuantile Range) onde:
  *IQR  = Q3(quartil 3) - Q1(quartil 1)
Com o IQR calculado é necessário definir o limite inferior e superior que é dado pela seguinte formula:

  $$Lim_{Sup} = \bar{X} + 1,5  * IQR$$
  
  $$Lim_{Inf} = \bar{X} - 1,5  * IQR$$

Para elucidar a aplicação do método vamos analisar a variavel **"Acidez Fixa"** notamos que há muitos valores acima do Q3 a uns poucos abaixo de Q1, Oserve o sumário desta variavel

```{r }

  skim(acidez_fixa)

  #dado p25(Q1) = 6.4 e p75(Q3) = 7.7 temos:
  IQR_Acidez_Volatil =7.7 - 6.4
  
  #como resultado temos 1.3 
  #com isso podemos definir os limites superior e inferior do range
  
  LS_acidez_fixa = 7.7 +  1.5 * IQR_Acidez_Volatil
  LI_acidez_fixa = 6.4 - (1.5 * IQR_Acidez_Volatil)
  
  #temos um limite superior de -0.025 e inferior de 0.655 onde as observações acima ou abaixo desses fatores serão consideradas outilers
  #com base nos limites encontrados farei um sub set do conjunto origi nal de dados levando em consideracao os limites encontrados
  Vinhos_Normalizado <-filter(vinhos, acidez_fixa >= LI_acidez_fixa & acidez_fixa <= LS_acidez_fixa)
  
  #comparando os resultados
  par(mfrow=c(1,2), oma = c(1,1,0,0) + 0.1,  mar = c(3,3,1,1) + 0.1)
    boxplot(acidez_fixa, col="slategray2", pch=19)
    mtext("Antes" , cex=0.8, side=1, line=2)
    boxplot(Vinhos_Normalizado$acidez_fixa, col="slategray2", pch=19)
    mtext("Depois" , cex=0.8, side=1, line=2)

```


Para automatizar o processo de analise e remoção dos outliers criamos uma função para executar essa tarefa, e segue:

```{r , results="hide"}




#criando uma funcao para remover os outliers das colunas 
remove_outliers <- function(x, na.rm = TRUE, ...) {
  qnt <- quantile(x, probs=c(.25, .75), na.rm = na.rm, ...)
  H <- 1.5 * IQR(x, na.rm = na.rm)
  y <- x
  y[x < (qnt[1] - H)] <- NA
  y[x > (qnt[2] + H)] <- NA
  y
}

vinhos$acidez_fixa <- remove_outliers(acidez_fixa, T)
vinhos$acidez_volatil <- remove_outliers(acidez_volatil)
vinhos$acido_citrico <- remove_outliers(acido_citrico, T)
vinhos$acucar_residual <- remove_outliers(acucar_residual, T)
vinhos$cloretos <- remove_outliers(cloretos, T)
vinhos$fsd <- remove_outliers(fsd, T)
vinhos$tsd <- remove_outliers(tsd, T)
vinhos$densidade <- remove_outliers(densidade, T)
vinhos$PH <- remove_outliers(PH, T)
vinhos$sulfatos <- remove_outliers(sulfatos, T)
vinhos$grau_alcolico <- remove_outliers(grau_alcolico, T)
vinhos$qualidade <- remove_outliers(qualidade, T)

```

Examinando os dados pos limpeza dos outliers

```{r}



  
```
